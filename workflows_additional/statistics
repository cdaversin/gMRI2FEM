rule segment_refinements:
  input:
    reference="data/mri_processed_data/{subject}/T1maps/{subject}_ses-01_T1map.nii.gz",
    segmentation="data/mri_processed_data/freesurfer/{subject}/mri/aparc+aseg.mgz",
    csfmask="data/mri_processed_data/{subject}/{subject}_csfmask.nii.gz",
  output:
    refined="data/mri_processed_data/{subject}/{subject}_aparc+aseg_refined.nii.gz",
    csf_segmentation="data/mri_processed_data/{subject}/{subject}_aparc+aseg_csfseg.nii.gz"
  shell:
    "python gmri2fem/analysis/segmentation_refinement.py"
    " --fs_seg {input.segmentation}"
    " --reference {input.reference}"
    " --csfmask {input.csfmask}"
    " --output_seg {output.refined}"
    " --output_csfseg {output.csf_segmentation}"


rule mri_region_stats:
    input:
      segmentation="data/mri_processed_data/{subject}/{subject}_aparc+aseg_refined.nii.gz",
      timestamps="data/mri_dataset/timetable.csv",
      lutfile="data/mri_processed_data/freesurfer_lut.json"
    shell:
      "python gmri2fem/analysis/region_quantities.py"
      " --subjectid {wildcards.subject}"
      " --subject_session {wildcards.session}"
      " --sequence {params.sequence}"
      " --timestamp_sequence {params.timestamp_sequence}"
      " --data {input.data}"
      " --seg {input.segmentation}"
      " --timestamps {input.timestamps}"
      " --lutfile {input.lutfile}"
      " --output {output}"



use rule mri_region_stats as LookLocker_stats with:
    input:
      segmentation="data/mri_processed_data/{subject}/{subject}_aparc+aseg_refined.nii.gz",
      timestamps="data/mri_dataset/timetable.csv",
      lutfile="data/mri_processed_data/freesurfer_lut.json",
      data="data/mri_processed_data/{subject}/T1maps/{subject}_{session}_T1map.nii.gz"
    output:
      "data/mri_processed_data/{subject}/statistics/{subject}_{session}_LookLocker_statstable.csv"
    params:
      sequence="LookLocker",
      timestamp_sequence="LookLocker"


# rule LookLocker_stats:
#     input:
#       data="data/mri_processed_data/{subject}/T1maps/{subject}_{session}_T1map.nii.gz",
#       segmentation="data/mri_processed_data/{subject}/{subject}_aparc+aseg_refined.nii.gz",
#       timestamps="data/mri_dataset/timetable.csv",
#       lutfile="data/mri_processed_data/freesurfer_lut.json"
#     output:
#       "data/mri_processed_data/{subject}/statistics/{subject}_{session}_LookLocker_statstable.csv"
#     shell:
#       "python gmri2fem/analysis/region_quantities.py"
#       " --subjectid {wildcards.subject}"
#       " --subject_session {wildcards.session}"
#       " --sequence LookLocker" #"T1map"
#       " --data {input.data}"
#       " --seg {input.segmentation}"
#       " --timestamps {input.timestamps}"
#       " --lutfile {input.lutfile}"
#       " --output {output}"


rule LookLocker_collected:
  input:
    expand(
      "data/mri_processed_data/{{subject}}/statistics/{{subject}}_{session}_LookLocker_statstable.csv",
      session=SESSIONS
    )
  output:
    "data/mri_processed_data/{subject}/statistics/{subject}_LookLocker_statstable.csv",
  shell:
    "python gmri2fem/analysis/concat_tables.py"
    " --input {input}"
    " --output {output}"

rule T1w_stats:
    input:
      data="data/mri_processed_data/{subject}/registered/{subject}_{session}_T1w_registered.nii.gz",
      segmentation="data/mri_processed_data/{subject}/{subject}_aparc+aseg_refined.nii.gz",
      timestamps="data/mri_dataset/timetable.csv",
      lutfile="data/mri_processed_data/freesurfer_lut.json"
    output:
      "data/mri_processed_data/{subject}/statistics/{subject}_{session}_T1w_statstable.csv"
    shell:
      "python gmri2fem/analysis/region_quantities.py"
      " --subjectid {wildcards.subject}"
      " --subject_session {wildcards.session}"
      " --sequence T1w"
      " --data {input.data}"
      " --seg {input.segmentation}"
      " --timestamps {input.timestamps}"
      " --lutfile {input.lutfile}"
      " --output {output}"

rule mixed_stats:
    input:
      data="data/mri_processed_data/{subject}/T1maps/{subject}_{session}_T1map.nii.gz",
      segmentation="data/mri_processed_data/{subject}/{subject}_aparc+aseg_csfseg.nii.gz",
      timestamps="data/mri_dataset/timetable.csv",
      lutfile="data/mri_processed_data/freesurfer_lut.json"
    output:
      "data/mri_processed_data/{subject}/statistics/{subject}_{session}_mixed_statstable.csv"
    shell:
      "python gmri2fem/analysis/region_quantities.py"
      " --subjectid {wildcards.subject}"
      " --subject_session {wildcards.session}"
      " --sequence mixed"
      " --data {input.data}"
      " --seg {input.segmentation}"
      " --timestamps {input.timestamps}"
      " --lutfile {input.lutfile}"
      " --output {output}"


rule concentration_tissue_stats:
    input:
      data="data/mri_processed_data/{subject}/concentrations/{subject}_{session}_concentration.nii.gz",
      segmentation="data/mri_processed_data/{subject}/{subject}_aparc+aseg_refined.nii.gz",
      timestamps="data/mri_dataset/timetable.csv",
      lutfile="data/mri_processed_data/freesurfer_lut.json"
    output:
      "data/mri_processed_data/{subject}/statistics/{subject}_{session}_concentration_statstable.csv"
    shell:
      "python gmri2fem/analysis/region_quantities.py"
      " --subjectid {wildcards.subject}"
      " --subject_session {wildcards.session}"
      " --sequence concentrations"
      " --timestamp_sequence LookLocker"
      " --data {input.data}"
      " --seg {input.segmentation}"
      " --timestamps {input.timestamps}"
      " --lutfile {input.lutfile}"
      " --output {output}"


rule concentration_csf_stats:
    input:
      data="data/mri_processed_data/{subject}/concentrations/{subject}_{session}_concentration.nii.gz",
      segmentation="data/mri_processed_data/{subject}/{subject}_aparc+aseg_csfseg.nii.gz",
      timestamps="data/mri_dataset/timetable.csv",
      lutfile="data/mri_processed_data/freesurfer_lut.json"
    output:
      "data/mri_processed_data/{subject}/statistics/{subject}_{session}_concentration_csf_statstable.csv"
    shell:
      "python gmri2fem/analysis/region_quantities.py"
      " --subjectid {wildcards.subject}"
      " --subject_session {wildcards.session}"
      " --sequence concentrations_csf"
      " --timestamp_sequence mixed"
      " --data {input.data}"
      " --seg {input.segmentation}"
      " --timestamps {input.timestamps}"
      " --lutfile {input.lutfile}"
      " --output {output}"



rule subject_collected:
  input:
    lambda wc: [
      f"data/mri_processed_data/{wc.subject}/statistics/{wc.subject}_{session}_{seq}_statstable.csv"
      for session in SESSIONS[wc.subject]
      for seq in ["T1w", "LookLocker", "mixed", "concentration", "concentration_csf"]
    ]
  output:
    "data/mri_processed_data/{subject}/statistics/{subject}_statstable.csv",
  shell:
    "python gmri2fem/analysis/concat_tables.py"
    " --input {input}"
    " --output {output}"



rule all_collected:
  input:
    [
      f"data/mri_processed_data/{subject}/statistics/{subject}_{session}_{seq}_statstable.csv"
      for subject in SUBJECTS
      for session in SESSIONS[subject]
      for seq in ["T1w", "LookLocker", "mixed", "concentration", "concentration_csf"]
    ]

